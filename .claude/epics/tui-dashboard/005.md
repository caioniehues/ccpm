---
id: "005"
name: Create Model/Update/View core architecture
status: completed
created: 2025-12-23T19:45:00Z
updated: 2025-12-23T20:15:00Z
depends_on: ["003", "004"]
parallel: false
conflicts_with: []
effort: L
---

# Task: Create Model/Update/View Core Architecture

## Description

Implement the Elm architecture (Model, Update, View) that forms the foundation of the Bubbletea TUI. This includes the main application state, message routing, and view composition.

## Acceptance Criteria

- [ ] Model struct contains all application state
- [ ] ViewMode enum for different screens (Dashboard, Epic, Task, PRD, Wizard, Help, Settings, Search)
- [ ] Update function handles all message types
- [ ] View function renders based on current ViewMode
- [ ] Bubbles components integrated (list, viewport, progress, spinner, help)
- [ ] Window resize handling works correctly
- [ ] Quit command works from any view

## Files to Create

### internal/tui/model.go

```go
package tui

import (
    "github.com/charmbracelet/bubbles/help"
    "github.com/charmbracelet/bubbles/list"
    "github.com/charmbracelet/bubbles/progress"
    "github.com/charmbracelet/bubbles/spinner"
    "github.com/charmbracelet/bubbles/viewport"
)

// ViewMode represents the current screen
type ViewMode int

const (
    ViewDashboard ViewMode = iota
    ViewEpicDetail
    ViewTaskDetail
    ViewPRDDetail
    ViewWizard
    ViewEpicSelector
    ViewHelp
    ViewSettings
    ViewSearch
)

// Model holds all application state
type Model struct {
    // Data
    Epics       []Epic
    ActiveEpic  *Epic
    Tasks       []Task
    ActiveTask  int
    PRDs        []PRD
    ActivityLog []ActivityEntry

    // UI State
    View        ViewMode
    Loading     bool
    LastError   error
    Ready       bool

    // Wizard State
    WizardStep  int
    WizardName  string

    // Components
    TaskList    list.Model
    Progress    progress.Model
    Viewport    viewport.Model
    Spinner     spinner.Model
    Help        help.Model

    // Dimensions
    Width       int
    Height      int
}

// Epic represents an epic from .claude/epics/
type Epic struct {
    Name        string
    Status      string
    Progress    float64
    TaskCount   int
    DoneCount   int
    Description string
    PRDName     string
    Branch      string
    CreatedAt   string
    ApprovedAt  string
}

// Task represents a task file
type Task struct {
    ID          string
    Name        string
    Status      string  // pending, in-progress, completed, blocked
    Epic        string
    Description string
    Progress    float64
}

// PRD represents a PRD file
type PRD struct {
    Name        string
    Status      string
    Content     string
    CreatedAt   string
    ApprovedAt  string
}

// ActivityEntry for the activity log
type ActivityEntry struct {
    Time    string
    Message string
    Type    string  // success, info, warning, error
}

// NewModel creates a new model with defaults
func NewModel() Model {
    s := spinner.New()
    s.Spinner = spinner.Dot
    s.Style = AccentStyle

    return Model{
        View:     ViewDashboard,
        Spinner:  s,
        Help:     help.New(),
        Progress: progress.New(progress.WithDefaultGradient()),
    }
}
```

### internal/tui/update.go

```go
package tui

import (
    "github.com/charmbracelet/bubbles/key"
    tea "github.com/charmbracelet/bubbletea"
)

// Message types
type (
    FileChangedMsg struct {
        Path string
    }
    EpicsLoadedMsg struct {
        Epics []Epic
    }
    TasksLoadedMsg struct {
        Tasks []Task
    }
    ErrorMsg struct {
        Err error
    }
)

func (m Model) Init() tea.Cmd {
    return tea.Batch(
        m.Spinner.Tick,
        loadEpics(),
    )
}

func (m Model) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    var cmds []tea.Cmd

    switch msg := msg.(type) {
    case tea.KeyMsg:
        return m.handleKeyPress(msg)

    case tea.WindowSizeMsg:
        m.Width = msg.Width
        m.Height = msg.Height
        m.Ready = true
        return m, nil

    case FileChangedMsg:
        return m, loadEpics()

    case EpicsLoadedMsg:
        m.Epics = msg.Epics
        m.Loading = false
        return m, nil

    case ErrorMsg:
        m.LastError = msg.Err
        m.Loading = false
        return m, nil

    case spinner.TickMsg:
        var cmd tea.Cmd
        m.Spinner, cmd = m.Spinner.Update(msg)
        return m, cmd
    }

    return m, tea.Batch(cmds...)
}

func (m Model) handleKeyPress(msg tea.KeyMsg) (tea.Model, tea.Cmd) {
    switch {
    case key.Matches(msg, Keys.Quit):
        return m, tea.Quit

    case key.Matches(msg, Keys.Help):
        if m.View == ViewHelp {
            m.View = ViewDashboard
        } else {
            m.View = ViewHelp
        }
        return m, nil

    case key.Matches(msg, Keys.Back):
        m.View = ViewDashboard
        return m, nil

    case key.Matches(msg, Keys.Epic):
        m.View = ViewEpicDetail
        return m, nil

    case key.Matches(msg, Keys.Tasks):
        m.View = ViewTaskDetail
        return m, nil

    case key.Matches(msg, Keys.PRD):
        m.View = ViewPRDDetail
        return m, nil

    case key.Matches(msg, Keys.Wizard):
        m.View = ViewWizard
        return m, nil
    }

    // Pass to current view's key handler
    return m.updateCurrentView(msg)
}

func (m Model) updateCurrentView(msg tea.KeyMsg) (tea.Model, tea.Cmd) {
    switch m.View {
    case ViewDashboard:
        return m.updateDashboard(msg)
    case ViewEpicDetail:
        return m.updateEpicDetail(msg)
    // ... other views
    }
    return m, nil
}

func loadEpics() tea.Cmd {
    return func() tea.Msg {
        // Will be implemented in parser task
        return EpicsLoadedMsg{Epics: []Epic{}}
    }
}
```

### internal/tui/view.go

```go
package tui

import "github.com/charmbracelet/lipgloss"

func (m Model) View() string {
    if !m.Ready {
        return "Initializing..."
    }

    switch m.View {
    case ViewDashboard:
        return m.viewDashboard()
    case ViewEpicDetail:
        return m.viewEpicDetail()
    case ViewTaskDetail:
        return m.viewTaskDetail()
    case ViewPRDDetail:
        return m.viewPRDDetail()
    case ViewWizard:
        return m.viewWizard()
    case ViewEpicSelector:
        return m.viewEpicSelector()
    case ViewHelp:
        return m.viewHelp()
    case ViewSettings:
        return m.viewSettings()
    case ViewSearch:
        return m.viewSearch()
    default:
        return m.viewDashboard()
    }
}

func (m Model) viewDashboard() string {
    // Placeholder - implemented in views/dashboard.go
    return "Dashboard View"
}

// ... placeholder methods for other views
```

## Definition of Done

- Elm architecture correctly implemented
- All views accessible via keybindings
- Window resize updates dimensions
- Spinner animation works
- Clean quit from any screen
